<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>YouTube Comment Picker ‚Äî Final</title>
<style>
  :root{
    --bg1:#0b6aa6;
    --bg2:#063b5e;
    --accent:#0078ff;
    --card:#ffffff;
    --card-text:#07304f;
    --muted:#6fa7d4;
    --glass: rgba(255,255,255,0.06);
    --radius:14px;
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;background:linear-gradient(180deg,var(--bg1),var(--bg2));display:flex;align-items:center;justify-content:center;padding:28px;color:#fff}
  .wrap{width:100%;max-width:980px;display:grid;grid-template-columns:1fr 420px;gap:22px}
  .panel{
    background:var(--glass);
    border-radius:var(--radius);
    padding:20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.35);
    border:1px solid rgba(255,255,255,0.03);
  }
  h1{margin:0;font-size:20px;font-weight:800;color:#e8f8ff}
  .hint{color:rgba(255,255,255,0.85);font-size:13px;margin-top:8px}
  label{display:block;color:#e6f6ff;font-weight:700;margin-top:14px;font-size:13px}
  input[type="text"]{width:100%;padding:12px;border-radius:10px;border:none;font-size:15px;margin-top:8px;background:#f6fbff;color:var(--card-text)}
  .checkbox{display:flex;align-items:center;gap:8px;margin-top:8px;color:#dff1ff}
  .btn{width:100%;padding:12px;border-radius:10px;border:none;background:linear-gradient(180deg,var(--accent),#0051d9);color:#fff;font-weight:800;cursor:pointer;margin-top:12px;box-shadow:0 10px 24px rgba(0,110,255,0.16)}
  .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.12);color:#eaf7ff}
  .status{display:none;margin-top:12px;padding:12px;border-radius:10px;background:linear-gradient(90deg,#0f6ea8,#0b5da0);font-weight:700;text-align:center}
  
  .card{background:var(--card);color:var(--card-text);border-radius:18px;padding:18px;box-shadow:0 14px 50px rgba(0,0,0,0.25);display:flex;flex-direction:column;gap:12px;min-height:420px}
  .trophy{width:66px;height:66px;border-radius:16px;background:linear-gradient(180deg,#ffd66f,#ffb347);display:flex;align-items:center;justify-content:center;margin:0 auto;box-shadow:0 8px 18px rgba(255,160,60,0.15);font-size:26px}
  .winnerPic{width:84px;height:84px;border-radius:999px;overflow:hidden;margin:6px auto;display:none;border:3px solid #fff;box-shadow:0 8px 18px rgba(0,0,0,0.12)}
  .winnerPic img{width:100%;height:100%;object-fit:cover;display:block}
  .winnerName{text-align:center;font-weight:800;font-size:20px;color:var(--card-text)}
  .winnerName a{text-decoration:none;color:var(--card-text)}
  .winnerComment{display:none;background:#f7fbff;padding:12px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);color:var(--card-text);font-size:14px}
  .details{background:#f3f8ff;border-radius:10px;padding:10px;border:1px solid rgba(0,0,0,0.06);color:var(--card-text)}
  .drow{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid rgba(0,0,0,0.04)}
  .drow:last-child{border-bottom:none}
  .randomFlash{background:#eaf6ff;color:#03314a;padding:10px;border-radius:8px;text-align:center;margin-top:8px}
  .actions{display:flex;gap:12px;justify-content:center;margin-top:auto}
  .primary{background:linear-gradient(180deg,#006aff,#0051d9);color:#fff;padding:12px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:800}
  .neutral{background:transparent;border:1px solid rgba(0,0,0,0.06);padding:12px 14px;border-radius:10px;color:var(--card-text);cursor:pointer;font-weight:700}
  
</style>
</head>
<body>
  <div class="wrap">
    
    <div class="panel">
      <h1>YouTube Comment Picker</h1>
      <div class="hint">Paste a YouTube link (watch / shorts / youtu.be). The tool will load comments and pick a winner.</div>

      <label>Paste YouTube link</label>
      <input id="videoLink" type="text" placeholder="https://youtu.be/..." />

      <div class="checkbox">
        <input id="filterDup" type="checkbox" checked />
        <span>Filter duplicate users</span>
      </div>

      <button class="btn" onclick="loadComments()">Load All Comments</button>
      <button class="btn secondary" onclick="clearAll()">Clear</button>

      <div id="statusBox" class="status"></div>

      <button id="pickBtn" class="btn" style="display:none;" onclick="pickWinner()">Pick Winner</button>
    </div>

    <div class="card">
      <div class="trophy">üèÜ</div>

      <div class="winnerPic" id="winnerPic">
        <img id="winnerImg" src="">
      </div>

      <div class="winnerName" id="winnerName">‚Äî</div>

      <div class="winnerComment" id="winnerComment"></div>

      <div class="details" id="details" style="display:none">
        <div class="drow"><div>Entries</div><div id="entries">0</div></div>
        <div class="drow"><div>Date</div><div id="date">‚Äî</div></div>
        <div class="drow"><div>Video</div><div><a id="videoLinkOut" target="_blank">Open</a></div></div>
      </div>

      <div id="flashArea"></div>

      <div class="actions">
        <button id="newBtn" class="neutral" onclick="resetWinner()" style="display:none;">Pick New Winner</button>
      </div>
    </div>

  </div>

<script>
/* ---------------- CONFIG ---------------- */
const BACKEND_URL = "https://script.google.com/macros/s/AKfycbwrudRpmIP1rzMD79VpZUb1AYKs3Wxne1eD6FfBjWlPyyucpvgZ1mp8f3cb3xoN09SW/exec";

/* State */
let pool = [];          
let totals = { totalComments:0, uniqueUsers:0 };
let currentVideoId = "";

/* Helpers */
function extractVideoId(link){
  try{
    const u = new URL(link);
    if(u.searchParams.get("v")) return u.searchParams.get("v");
    if(u.hostname==="youtu.be") return u.pathname.slice(1);
    if(u.pathname.startsWith("/shorts/")) return u.pathname.split("/")[2];
  }catch(e){}
  return null;
}
function show(e){e.style.display="block";}
function hide(e){e.style.display="none";}

/* ---------- Load Comments ---------- */
async function loadComments(){
  const link = document.getElementById("videoLink").value.trim();
  const vid = extractVideoId(link);
  const box = document.getElementById("statusBox");
  const pickBtn = document.getElementById("pickBtn");

  hide(document.getElementById("winnerPic"));
  hide(document.getElementById("winnerComment"));
  hide(document.getElementById("details"));
  hide(document.getElementById("newBtn"));
  document.getElementById("winnerName").textContent = "‚Äî";
  document.getElementById("flashArea").innerHTML = "";

  if(!vid){
    show(box);
    box.textContent = "‚ùå Invalid YouTube URL";
    return;
  }

  currentVideoId = vid;

  show(box);
  box.textContent = "‚è≥ Loading comments‚Ä¶";
  hide(pickBtn);

  try{
    const res = await fetch(`${BACKEND_URL}?videoId=${encodeURIComponent(vid)}`);
    const data = await res.json();

    if(data.error){
      box.textContent = "‚ùå Backend Error: " + (data.error.message || JSON.stringify(data.error));
      return;
    }

    totals.totalComments = data.totalComments || 0;
    totals.uniqueUsers = data.uniqueUsers || 0;

    box.innerHTML = `‚úÖ Loaded <strong>${totals.totalComments}</strong> comments<br>üéØ Unique users: <strong>${totals.uniqueUsers}</strong>`;

    pool = data.pool || [];

    document.getElementById("entries").textContent = totals.uniqueUsers;
    document.getElementById("date").textContent = new Date().toLocaleString();
    document.getElementById("videoLinkOut").href = `https://youtube.com/watch?v=${vid}`;
    show(document.getElementById("details"));

    if(pool.length > 0){
      show(pickBtn);
    } else {
      pickBtn.style.display = "none";
      box.textContent = "‚ö†Ô∏è No comments available.";
    }

  }catch(err){
    console.log(err);
    box.textContent = "‚ùå Error fetching comments (network error).";
  }
}

/* ---------- Pick Winner ---------- */
function pickWinner(){
  if(pool.length===0){ alert("No comments."); return; }

  const flash = document.getElementById("flashArea");
  const pickBtn = document.getElementById("pickBtn");
  const newBtn = document.getElementById("newBtn");

  hide(pickBtn);
  flash.innerHTML = "";

  let rounds = 25;
  let i = 0;

  const x = setInterval(()=>{
    const r = pool[Math.floor(Math.random()*pool.length)];
    flash.innerHTML = `<div class='randomFlash'>${r.author}</div>`;
    i++;
    if(i >= rounds){
      clearInterval(x);

      const final = pool[Math.floor(Math.random()*pool.length)];

      document.getElementById("winnerName").innerHTML =
        `<a href="https://youtube.com/channel/${final.channelId}" target="_blank">@${final.author}</a>`;

      if(final.comment){
        const w = document.getElementById("winnerComment");
        w.textContent = final.comment;
        show(w);
      }

      if(final.profileImageUrl){
        document.getElementById("winnerImg").src = final.profileImageUrl;
        show(document.getElementById("winnerPic"));
      }

      flash.innerHTML = "";
      show(newBtn);
    }
  },90);
}

/* ---------- Reset Winner ---------- */
function resetWinner(){
  document.getElementById("winnerName").textContent = "‚Äî";
  hide(document.getElementById("winnerComment"));
  hide(document.getElementById("winnerPic"));
  hide(document.getElementById("newBtn"));
  document.getElementById("flashArea").innerHTML = "";
  show(document.getElementById("pickBtn"));
}

/* ---------- Clear ---------- */
function clearAll(){
  document.getElementById("videoLink").value="";
  hide(document.getElementById("statusBox"));
  hide(document.getElementById("winnerPic"));
  hide(document.getElementById("winnerComment"));
  hide(document.getElementById("details"));
  hide(document.getElementById("pickBtn"));
  hide(document.getElementById("newBtn"));
  document.getElementById("winnerName").textContent="‚Äî";
  document.getElementById("flashArea").innerHTML="";
  pool=[];
}
</script>
</body>
</html>
