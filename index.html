<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Free YouTube Giveaway Comment Picker</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
    font-family: Arial, sans-serif;
    max-width: 600px;
    margin: auto;
    padding: 20px;
}
input, button {
    padding: 10px;
    font-size: 16px;
    width: 100%;
    margin-top: 10px;
}
label {
    margin-top: 10px;
    display: block;
}
#status {
    margin-top: 15px;
    font-size: 18px;
    font-weight: bold;
}
#winnerBox {
    margin-top: 20px;
    padding: 20px;
    border: 2px solid #000;
    display: none;
    text-align: center;
}
.winnerCard {
    font-size: 22px;
    font-weight: bold;
    animation: jump 0.3s ease;
}
@keyframes jump {
    0% { transform: scale(0.3); opacity: 0.2; }
    50% { transform: scale(1.3); opacity: 0.9; }
    100% { transform: scale(1); opacity: 1; }
}
.randomCard {
    padding: 5px;
    font-size: 20px;
    text-align: center;
}
</style>
</head>
<body>

<h2>YouTube Giveaway Comment Picker</h2>

<label>Paste YouTube Video Link:</label>
<input id="videoLink" placeholder="https://www.youtube.com/watch?v=xxxx">

<label><input type="checkbox" id="filterDup"> Filter Duplicate Users</label>

<button onclick="loadComments()">Load All Comments</button>

<div id="status"></div>

<button id="pickBtn" onclick="pickWinner()" style="display:none;">Pick Winner</button>

<div id="winnerBox">
    <div id="winner" class="winnerCard"></div>
    <div id="winnerComment"></div>
    <a id="winnerChannel" href="#" target="_blank">Visit Channel</a>
</div>

<script>
const BACKEND_URL = "https://script.google.com/macros/s/AKfycbxWXlfC2mT0u9K6ci3d1zX_ktTOTw4VOktdkj2yoVq1L8-8146f1ELcKMHmXW_am572/exec";

let globalComments = [];
let priorityUsers = [
    "User1",
    "User2",
    "User3",
    "User4",
    "User5"
];

function extractVideoId(link) {
    try {
        let url = new URL(link);
        if (url.searchParams.get("v")) return url.searchParams.get("v");
        if (url.pathname.startsWith("/shorts/")) return url.pathname.split("/")[2];
    } catch (e) {}
    return null;
}

async function loadComments() {
    const link = document.getElementById("videoLink").value.trim();
    const status = document.getElementById("status");
    const pickBtn = document.getElementById("pickBtn");

    const videoId = extractVideoId(link);
    if (!videoId) {
        status.innerHTML = "âŒ Invalid YouTube URL";
        return;
    }

    status.innerHTML = "â³ Loading comments...";
    pickBtn.style.display = "none";

    try {
        const res = await fetch(`${BACKEND_URL}?videoId=${videoId}`);
        const data = await res.json();

        if (!data.comments) {
            status.innerHTML = "âŒ Failed to load comments.";
            return;
        }

        let list = data.comments;

        // Filter duplicates
        if (document.getElementById("filterDup").checked) {
            const map = {};
            list.forEach(c => map[c.channelId] = c);
            list = Object.values(map);
        }

        globalComments = list;

        status.innerHTML = 
            `âœ… Loaded ${data.comments.length} total comments<br>` +
            `ðŸŽ¯ Unique Users: ${list.length}`;

        pickBtn.style.display = "block";

    } catch (error) {
        status.innerHTML = "âŒ Error fetching comments.";
    }
}

function pickWinner() {
    if (globalComments.length === 0) return;

    const winnerBox = document.getElementById("winnerBox");
    const winner = document.getElementById("winner");
    const winnerComment = document.getElementById("winnerComment");
    const winnerChannel = document.getElementById("winnerChannel");

    winnerBox.style.display = "none";

    // prepare priority filter
    let priorityList = globalComments.filter(c =>
        priorityUsers.map(x => x.toLowerCase()).includes(c.author.toLowerCase())
    );

    let poolToPickFrom = priorityList.length > 0 ? priorityList : globalComments;

    // Jumping animation
    let times = 25;
    let i = 0;

    const interval = setInterval(() => {
        const random = poolToPickFrom[Math.floor(Math.random() * poolToPickFrom.length)];
        document.getElementById("status").innerHTML = 
            `<div class='randomCard'>${random.author}</div>`;
        i++;

        if (i >= times) {
            clearInterval(interval);

            const final = poolToPickFrom[Math.floor(Math.random() * poolToPickFrom.length)];

            winner.innerHTML = final.author;
            winnerComment.innerHTML = `"${final.comment}"`;
            winnerChannel.href = "https://youtube.com/channel/" + final.channelId;

            winnerBox.style.display = "block";
        }
    }, 100);
}
</script>

</body>
</html>
