<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>YouTube Random Comment Picker</title>

<style>
:root{
  --brand:#1788D1;
  --white:#fff;
  --dark:#052536;
  --shadow:0 18px 44px rgba(3,25,40,0.12);
  --card-radius:20px;
}

html,body{
  margin:0;
  padding:0;
  height:100%;
  background:var(--brand);
  font-family:Inter,system-ui,Arial;
  color:var(--white);
}

.container{
  max-width:980px;
  margin:26px auto;
  padding:20px;
}

/* HEADER */
.header{text-align:center;margin-bottom:20px}
.title{
  font-size:44px;
  font-weight:900;
  margin:0;
}
.subtitle{
  font-size:20px;
  font-weight:700;
  opacity:0.9;
  margin-top:8px;
  text-transform:uppercase;
  letter-spacing:1px;
}

/* CONTROLS */
.controlsWrap{
  margin-top:20px;
  display:flex;
  flex-direction:column;
  gap:20px;
}

.whiteCard{
  width:100%;
  background:var(--white);
  color:var(--dark);
  border-radius:var(--card-radius);
  padding:24px;
  box-shadow:var(--shadow);
  box-sizing:border-box;
}

.labelText{
  font-weight:900;
  font-size:14px;
  color:var(--dark);
  margin-bottom:16px;
}

.inputMain{
  width:100%;
  padding:15px 16px;
  border-radius:999px;
  border:none;
  background:#f8f8f8;
  color:var(--dark);
  box-shadow:0 12px 30px rgba(0,0,0,0.08);
  margin-bottom:14px;
  font-size:16px;
}

.loadBtn{
  width:100%;
  padding:14px;
  border-radius:999px;
  border:none;
  background:var(--brand);
  color:#fff;
  font-weight:900;
  cursor:pointer;
  font-size:16px;
  box-shadow:0 12px 28px rgba(0,0,0,0.2);
}

.countText{
  text-align:center;
  font-weight:900;
  margin-top:12px;
  font-size:16px;
  color:var(--dark);
}

/* checkboxes keep on blue background */
.checkbox{
  display:flex;
  align-items:center;
  gap:10px;
  font-weight:900;
  cursor:pointer;
}

/* HASHTAG BOX */
.collapse{display:none}
.inputSmall{
  width:60%;
  padding:10px;
  border-radius:12px;
  border:none;
  background:#fff;
  color:var(--dark);
  box-shadow:0 6px 16px rgba(0,0,0,0.12);
}

/* STAGE */
.stage{
  background:var(--white);
  color:var(--dark);
  padding:28px;
  border-radius:22px;
  box-shadow:var(--shadow);
  margin-top:26px;
  display:none;
  flex-direction:column;
  align-items:center;
}

.hintTiny{
  font-size:12px;
  color:#588aa8;
  align-self:flex-start;
}

.avatar{
  width:120px;height:120px;border-radius:999px;overflow:hidden;
  border:6px solid var(--brand);
  display:none;
}
.avatar img{width:100%;height:100%;object-fit:cover;}

.handle{
  font-size:20px;
  font-weight:900;
  color:var(--brand);
  display:none;
}
.handle a{text-decoration:none;color:var(--brand)}

.commentBox{
  width:84%;
  background:#f7fbff;
  color:#114b63;
  padding:14px;
  border-radius:12px;
  display:none;
  box-shadow:0 8px 20px rgba(3,48,80,0.08);
}

/* START BUTTON */
.startBox{
  display:none;
  flex-direction:column;
  align-items:center;
  margin-top:20px;
}
.startCircle{
  width:150px;height:150px;border-radius:999px;
  border:10px solid var(--brand);
  background:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:900;font-size:20px;
  cursor:pointer;
  box-shadow:0 20px 50px rgba(0,0,0,0.18);
}
.startHint{color:#588aa8;margin-top:10px}

/* PICK AGAIN */
.pickAgain{
  display:none;
  margin-top:20px;
  width:100%;
  background:var(--brand);
  color:#fff;
  padding:14px;
  border-radius:12px;
  border:none;
  font-weight:900;
  cursor:pointer;
}

/* SHARE */
.shareRow{
  display:none;
  margin-top:10px;
  gap:10px;
  align-items:center;
}
.shareBtn{
  background:#0b6aa6;
  color:#fff;
  padding:8px 14px;
  border-radius:8px;
  border:none;
  cursor:pointer;
  font-weight:800;
}
#shareMsg{font-weight:800;color:var(--dark)}

/* CONFETTI */
#confetti{
  position:fixed;left:0;top:0;right:0;bottom:0;
  pointer-events:none;
  z-index:9999;
}

@media(max-width:720px){
  .title{font-size:32px}
  .avatar{width:100px;height:100px}
  .startCircle{width:120px;height:120px}
}
</style>
</head>

<body>
<div class="container">

  <!-- HEADER -->
  <div class="header">
    <div class="title">YOUTUBE RANDOM COMMENT PICKER</div>
    <div class="subtitle">giveaway winner picker</div>
  </div>

  <!-- FILTER CHECKBOXES (stay outside on blue background) -->
  <div class="controlsWrap">

    <label class="checkbox"><input id="filterDup" type="checkbox" checked> FILTER DUPLICATE & BOT COMMENTS</label>
    <label class="checkbox"><input id="useFilterWords" type="checkbox"> FILTER COMMENTS BY WORD / HASHTAG</label>

    <div id="collapse" class="collapse">
      <input id="filterWords" class="inputSmall" placeholder="giveaway,#win">
    </div>

    <!-- MERGED WHITE BOX -->
    <div class="whiteCard">
      <div class="labelText">VIDEO LINK BELOW</div>
      <input id="videoLink" class="inputMain" placeholder="https://youtu.be/...">

      <button id="loadBtn" class="loadBtn">GET TOTAL UNIQUE COMMENTS</button>

      <div id="countText" class="countText">Amount of comments: 0</div>
    </div>

  </div>

  <!-- STAGE -->
  <div id="stage" class="stage">
    <div id="topHint" class="hintTiny">Click start to pick a winner</div>

    <div id="avatarWrap" class="avatar"><img id="avatarImg"></div>
    <div id="handle" class="handle"></div>
    <div id="commentBox" class="commentBox"></div>

    <div id="startBox" class="startBox">
      <div id="startCircle" class="startCircle">START</div>
      <div class="startHint">Click to begin 10s raffle</div>
    </div>

    <button id="pickAgain" class="pickAgain">PICK A NEW WINNER</button>

    <div id="shareRow" class="shareRow">
      <button id="shareBtn" class="shareBtn">COPY WINNER LINK</button>
      <div id="shareMsg"></div>
    </div>

  </div>

</div>

<div id="confetti"></div>

<!-- SCRIPT -->
<script>
/* CONFIG */
const BACKEND_URL = "https://script.google.com/macros/s/AKfycbzS2QT2vSJ_RoXiQACij7iUWcmcJqFBHEelNrC7h1-XfRcdOx1gdQ1ZvJQuNruRRXM9xA/exec";
const RAFFLE_TIME = 10000;
const TICK = 60;

/* STATE */
let comments = [];
let pickPool = [];
let used = new Set();
let videoId = "";

/* DOM */
const videoLink = document.getElementById("videoLink");
const loadBtn = document.getElementById("loadBtn");
const countText = document.getElementById("countText");
const filterDup = document.getElementById("filterDup");
const useFilterWords = document.getElementById("useFilterWords");
const filterWords = document.getElementById("filterWords");
const collapse = document.getElementById("collapse");

const stage = document.getElementById("stage");
const startBox = document.getElementById("startBox");
const startCircle = document.getElementById("startCircle");

const avatarWrap = document.getElementById("avatarWrap");
const avatarImg = document.getElementById("avatarImg");
const handleEl = document.getElementById("handle");
const commentBox = document.getElementById("commentBox");

const pickAgain = document.getElementById("pickAgain");
const shareRow = document.getElementById("shareRow");
const shareBtn = document.getElementById("shareBtn");
const shareMsg = document.getElementById("shareMsg");

useFilterWords.onclick = ()=> collapse.style.display = useFilterWords.checked ? "block" : "none";

/* EXTRACT */
function extractID(url){
  try{
    const u = new URL(url);
    if(u.searchParams.get("v")) return u.searchParams.get("v");
    if(u.hostname==="youtu.be") return u.pathname.replace("/","");
    if(u.pathname.startsWith("/shorts/")) return u.pathname.split("/")[2];
  }catch{}
  return null;
}

/* LOAD COMMENTS */
loadBtn.onclick = async ()=>{
  const id = extractID(videoLink.value.trim());
  if(!id){ countText.innerHTML="❌ Invalid YouTube URL"; return; }
  videoId = id;

  comments = [];
  used.clear();
  countText.innerHTML="⏳ Loading...";
  loadBtn.disabled = true;

  const url = `${BACKEND_URL}?videoId=${encodeURIComponent(id)}&filterDup=${filterDup.checked}&filterWords=${encodeURIComponent(filterWords.value||"")}`;
  const res = await fetch(url);
  const data = await res.json();

  comments = data.comments || [];
  pickPool = data.pickPool || [];
  (data.usedWinners||[]).forEach(u=> used.add(u));
  comments = comments.filter(c=> !used.has(c.channelId));

  // count animation
  let cur = 0;
  const total = comments.length;
  const inc = Math.max(1, Math.floor(total/50));
  const i = setInterval(()=>{
    cur+=inc;
    if(cur>=total) cur=total;
    countText.innerHTML = `Amount of comments: <strong>${cur}</strong>`;
    if(cur>=total){ clearInterval(i); }
  },20);

  setTimeout(()=>{
    stage.style.display="flex";
    startBox.style.display="flex";
    loadBtn.disabled=false;
  },650);
};

/* BUILD SEQUENCE FOR LAG-FREE SHUFFLE */
function buildSequence(final){
  const steps = Math.floor(RAFFLE_TIME/TICK);
  const local = comments.filter(c=>(c.channelId!==final.channelId));
  if(local.length===0) local.push(...comments);

  let seq=[];
  while(seq.length < steps-1){
    seq = seq.concat(local.sort(()=>Math.random()-0.5));
  }
  seq = seq.slice(0,steps-1);
  seq.push(final);
  return seq;
}

/* PICK FINAL WINNER */
async function pickFinal(){
  // refresh pickPool
  const url = `${BACKEND_URL}?videoId=${encodeURIComponent(videoId)}&filterDup=${filterDup.checked}&filterWords=${encodeURIComponent(filterWords.value||"")}`;
  const data = await (await fetch(url)).json();
  pickPool = data.pickPool||[];
  (data.usedWinners||[]).forEach(u=> used.add(u));

  // remove used
  pickPool = pickPool.filter(p=> !used.has(p.channelId));

  let pool = pickPool.length ? pickPool : comments;
  pool = pool.filter(p=> !used.has(p.channelId));

  return pool[Math.floor(Math.random()*pool.length)];
}

/* SHOW FINAL RESULT */
async function showFinal(final){
  const key = final.channelId;
  used.add(key);
  comments = comments.filter(c=> c.channelId!==key);

  await fetch(BACKEND_URL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({action:"markWinner",videoId,channelId:key})
  });

  avatarWrap.style.display="flex";
  avatarImg.src=final.profileImageUrl||"";
  
  handleEl.style.display="block";
  handleEl.innerHTML = `<a href="https://youtube.com/channel/${final.channelId}" target="_blank">@${final.author}</a>`;
  
  commentBox.style.display="block";
  commentBox.innerHTML = final.comment;

  pickAgain.style.display="block";
  shareRow.style.display="flex";
}

/* START SHUFFLE — ZERO LAG */
async function startRaffle(){
  const final = await pickFinal();
  const seq = buildSequence(final);

  avatarWrap.style.display="flex";
  handleEl.style.display="block";
  commentBox.style.display="block";
  startBox.style.display="none";
  pickAgain.style.display="none";
  shareRow.style.display="none";

  let i=0;
  const iv=setInterval(()=>{
    const c = seq[i];
    avatarImg.src=c.profileImageUrl||"";
    handleEl.textContent = "@"+c.author;
    commentBox.textContent = c.comment;

    i++;
    if(i>=seq.length){
      clearInterval(iv);
      showFinal(final);
    }
  },TICK);
}

startCircle.onclick = startRaffle;
pickAgain.onclick = startRaffle;

</script>
</body>
</html>
